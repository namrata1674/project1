(this.webpackJsonp=this.webpackJsonp||[]).push([[40],{DN5t:function(e,t,i){"use strict";i.d(t,"a",(function(){return P}));var n=i("EmJ/"),s=i.n(n),a=i("XRO8"),o=i("2ibD"),r=i("/lV4"),l=i("06tH"),c=i.n(l);var d={init(e){var t=this;this.userCanCreateNote||(this.userCanCreateNote=""===e.closest(".files").data("canCreateNote")),this.isParallelView="parallel"===c.a.get("diff_view"),this.userCanCreateNote&&e.on("mouseover",".diff-line-num, .line_content",(function(e){return t.showButton(t.isParallelView,e)})).on("mouseleave",".diff-line-num, .line_content",(function(e){return t.hideButton(t.isParallelView,e)}))},showButton(e,t){const i=this.getButtonParent(t.currentTarget,e);this.validateButtonParent(i)&&(i.classList.add("is-over"),i.nextElementSibling.classList.add("is-over"))},hideButton(e,t){const i=this.getButtonParent(t.currentTarget,e);i.classList.remove("is-over"),i.nextElementSibling.classList.remove("is-over")},getButtonParent(e,t){if(t){if(!e.classList.contains("diff-line-num"))return e.previousElementSibling}else if(!e.classList.contains("old_line"))return e.parentNode.querySelector(".old_line");return e},validateButtonParent:e=>!(e.classList.contains("empty-cell")||e.classList.contains("js-unfold")||e.classList.contains("no-comment-btn")||e.parentNode.classList.contains("diff-expanded"))};i("S26F");const h=900,g=["two-up","swipe"];class u{constructor(e){var t,i,n,a=this;n={"two-up":function(){var e=this;return s()(".two-up.view .wrap",this.file).each((function(t,i){return s()("img",i).each((function(){if(s()(this).width()>h/2)return s()(this).width(h/2)})),e.requestImageInfo(s()("img",i),(function(e,t){return s()(".image-info .meta-width",i).text(`${e}px`),s()(".image-info .meta-height",i).text(`${t}px`),s()(".image-info",i).removeClass("gl-display-none")}))}))},swipe(){var e=this;let t=0,i=0;return s()(".swipe.view",this.file).each((function(n,a){const o=u.prepareFrames(a);[t,i]=o;const r=s()(".swipe-frame",a),l=s()(".swipe-wrap",a),c=s()(".swipe-bar",a);r.css({width:t+16,height:i+28}),l.css({width:t+1,height:i+2}),c.css({left:1});const d=parseInt(l.css("right").replace("px",""),10);e.initDraggable(c,d,(function(e,i){i>0&&i<r.width()-2*d&&(l.width(t+1-i),c.css("left",i))}))}))},"onion-skin":function(){var e=this;let t,i;i=0,t=0;const n=s()(".drag-track",this.file).width()-s()(".dragger",this.file).width();return s()(".onion-skin.view",this.file).each((function(a,o){const r=u.prepareFrames(o);[i,t]=r;const l=s()(".onion-skin-frame",o),c=s()(".frame.added",o),d=s()(".drag-track",o),h=s()(".dragger",d);l.css({width:i+16,height:t+28}),s()(".swipe-wrap",o).css({width:i+1,height:t+2}),h.css({left:n}),c.css("opacity",1);const g=parseInt(c.css("right").replace("px",""),10);e.initDraggable(h,g,(function(e,t){const i=t/n;i>=0&&i<=1&&(h.css("left",t),c.css("opacity",i))}))}))}},(i="views")in(t=this)?Object.defineProperty(t,i,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[i]=n,this.file=e,this.requestImageInfo(s()(".two-up.view .frame.deleted img",this.file),(function(){return a.requestImageInfo(s()(".two-up.view .frame.added img",a.file),(function(){a.initViewModes(),a.initView("two-up")}))}))}initViewModes(){var e=this;const t=g[0];return s()(".view-modes",this.file).removeClass("gl-display-none"),s()(".view-modes-menu",this.file).on("click","li",(function(t){if(!s()(t.currentTarget).hasClass("active"))return e.activateViewMode(t.currentTarget.className)})),this.activateViewMode(t)}activateViewMode(e){return s()(".view-modes-menu li",this.file).removeClass("active").filter(`.${e}`).addClass("active"),s()(`.view:visible:not(.${e})`,this.file).addClass("gl-display-none"),s()(`.view.${e}`,this.file).removeClass("gl-display-none"),this.initView(e)}initView(e){return this.views[e].call(this)}initDraggable(e,t,i){let n=!1;const a=s()("body"),o=e.parent(),r=function(){n=!0,a.css("user-select","none")},l=function(){n=!1,a.css("user-select","")},c=function(e){const s=(e.pageX||e.touches[0].pageX)-(o.offset().left+t);n&&i(e,s)};e.off("mousedown").off("touchstart").on("mousedown",r).on("touchstart",r),a.off("mouseup").off("mousemove").off("touchend").off("touchmove").on("mouseup",l).on("touchend",l).on("mousemove",c).on("touchmove",c)}static prepareFrames(e){let t=0,i=0;return s()(".frame",e).each((function(e,n){const a=s()(n).width(),o=s()(n).height();return t=a>t?a:t,i=o>i?o:i})).css({width:t,height:i}),[t,i]}requestImageInfo(e,t){var i=this;const n=e.get(0);if(n)return n.complete?t.call(this,n.naturalWidth,n.naturalHeight):e.on("load",(function(){return t.call(i,n.naturalWidth,n.naturalHeight)}))}}var f=i("NmEs");function m(e,{x:t,y:i},n=[]){const s=document.createElement("button");return n.concat(["js-image-badge"]).forEach((function(e){return s.classList.add(e)})),s.setAttribute("type","button"),s.setAttribute("disabled",!0),s.dataset.noteId=e,s.style.left=`${t}px`,s.style.top=`${i}px`,s}function p(e,{x:t,y:i}){const n=document.createElement("button");n.classList.add("btn-transparent"),n.classList.add("comment-indicator"),n.setAttribute("type","button"),n.style.left=`${t}px`,n.style.top=`${i}px`,n.innerHTML=Object(f.N)("image-comment-dark"),e.appendChild(n)}const w={x:0,y:0,width:0,height:0};class v{constructor(e){const{noteId:t,discussionId:i}=e;this.actual=e.actual||w,this.browser=e.browser||w,this.noteId=t,this.discussionId=i,e.imageEl&&!e.browser&&(this.browser=b.resizeCoordinatesToImageElement(e.imageEl,this.actual))}}var b={addCommentIndicator:p,removeCommentIndicator:function(e){const t=e.querySelector(".comment-indicator"),i=e.querySelector("img"),n=Boolean(t);let s={};return n&&(s={x:parseInt(t.style.left,10),y:parseInt(t.style.top,10),image:{width:i.width,height:i.height}},t.remove()),{...s,removed:n}},showCommentIndicator:function(e,t){const{x:i,y:n}=t,s=e.querySelector(".comment-indicator");s?(s.style.left=`${i}px`,s.style.top=`${n}px`):p(e,t)},commentIndicatorOnClick:function(e){e.stopPropagation(),e.currentTarget.closest(".diff-viewer").querySelector(".note-container .note-textarea").focus()},addImageBadge:function(e,{coordinate:t,badgeText:i,noteId:n}){const s=m(n,t,["badge","badge-pill"]);s.textContent=i,e.appendChild(s)},addImageCommentBadge:function(e,{coordinate:t,noteId:i}){const n=m(i,t,["image-comment-badge"]);n.innerHTML=Object(f.N)("image-comment-dark"),e.appendChild(n)},addAvatarBadge:function(e,t){const{noteId:i,badgeNumber:n}=t.detail,s=e.querySelector(`#${i} .badge`);s.textContent=n,s.classList.remove("hidden")},setPositionDataAttribute:function(e,t){const{x:i,y:n,width:s,height:a}=t,{position:o}=e.dataset,r={...JSON.parse(o),x:i,y:n,width:s,height:a};e.setAttribute("data-position",JSON.stringify(r))},updateDiscussionAvatarBadgeNumber:function(e,t){e.querySelector(".image-diff-avatar-link .badge").textContent=t},updateDiscussionBadgeNumber:function(e,t){e.querySelector(".badge").textContent=t},toggleCollapsed:function(e){const t=e.currentTarget.closest(".discussion-notes"),i=t.querySelector(".discussion-form"),n=t.classList.contains("collapsed");n?t.classList.remove("collapsed"):t.classList.add("collapsed"),i&&!n?i.style.display="none":i&&n&&(i.style.display="block")},resizeCoordinatesToImageElement:function(e,t){const{x:i,y:n,width:s,height:a}=t,o=e.width,r=e.height,l=o/s,c=r/a;return{x:Math.round(i*l),y:Math.round(n*c),width:o,height:r}},generateBadgeFromDiscussionDOM:function(e,t){const i=JSON.parse(t.dataset.position),n=t.querySelector(".note");return new v({actual:i,imageEl:e.querySelector("img"),noteId:n.id,discussionId:t.dataset.discussionId})},getTargetSelection:function(e){const t=e.currentTarget.querySelector("img"),i=e.offsetX,n=e.offsetY,{width:s,height:a}=t,o=t.naturalWidth,r=t.naturalHeight,l=o/s,c=r/a,d=Math.max(0,i)&&Math.min(i,s),h=Math.max(0,n)&&Math.min(n,a);return{browser:{x:d,y:h,width:s,height:a},actual:{x:Math.round(d*l),y:Math.round(h*c),width:o,height:r}}}};class C{constructor(e,t){this.el=e,this.canCreateNote=Boolean(t&&t.canCreateNote),this.renderCommentBadge=Boolean(t&&t.renderCommentBadge),this.$noteContainer=s()(".note-container",this.el),this.imageBadges=[]}init(){this.imageFrameEl=this.el.querySelector(".diff-file .js-image-frame"),this.imageEl=this.imageFrameEl.querySelector("img"),this.bindEvents()}bindEvents(){var e;this.imageClickedWrapper=this.imageClicked.bind(this),this.imageBlurredWrapper=b.removeCommentIndicator.bind(null,this.imageFrameEl),this.addBadgeWrapper=this.addBadge.bind(this),this.removeBadgeWrapper=this.removeBadge.bind(this),this.renderBadgesWrapper=this.renderBadges.bind(this),(e=this.imageEl).complete&&0!==e.naturalHeight?this.renderBadges():this.imageEl.addEventListener("load",this.renderBadgesWrapper),this.$noteContainer.on("click",".js-diff-notes-toggle",b.toggleCollapsed),s()(this.el).on("click",".comment-indicator",b.commentIndicatorOnClick),this.canCreateNote&&(this.el.addEventListener("click.imageDiff",this.imageClickedWrapper),this.el.addEventListener("blur.imageDiff",this.imageBlurredWrapper),this.el.addEventListener("addBadge.imageDiff",this.addBadgeWrapper),this.el.addEventListener("removeBadge.imageDiff",this.removeBadgeWrapper))}imageClicked(e){const t=e.detail,i=b.getTargetSelection(t),n=t.currentTarget;b.setPositionDataAttribute(n,i.actual),b.showCommentIndicator(this.imageFrameEl,i.browser)}renderBadges(){[...this.el.querySelectorAll(".note-container .discussion-notes .notes")].forEach(this.renderBadge.bind(this))}renderBadge(e,t){const i=b.generateBadgeFromDiscussionDOM(this.imageFrameEl,e);this.imageBadges.push(i);const n={coordinate:i.browser,noteId:i.noteId};if(this.renderCommentBadge)b.addImageCommentBadge(this.imageFrameEl,n);else{const e={...n,badgeText:t+1};b.addImageBadge(this.imageFrameEl,e)}}addBadge(e){const{x:t,y:i,width:n,height:s,noteId:a,discussionId:o}=e.detail,r=this.imageBadges.length+1,l=new v({actual:{x:t,y:i,width:n,height:s},imageEl:this.imageFrameEl.querySelector("img"),noteId:a,discussionId:o});this.imageBadges.push(l),b.addImageBadge(this.imageFrameEl,{coordinate:l.browser,badgeText:r,noteId:a}),b.addAvatarBadge(this.el,{detail:{noteId:a,badgeNumber:r}});const c=this.el.querySelector(`#discussion_${o}`);b.updateDiscussionBadgeNumber(c,r)}removeBadge(e){var t=this;const{badgeNumber:i}=e.detail,n=i-1,s=this.imageFrameEl.querySelectorAll(".badge");this.imageBadges.length!==i&&this.imageBadges.forEach((function(e,i){if(i>n){const{discussionId:n}=e,a=i,o=t.el.querySelector(`#discussion_${n}`);s[i].textContent=a,b.updateDiscussionBadgeNumber(o,a),b.updateDiscussionAvatarBadgeNumber(o,a)}})),this.imageBadges.splice(n,1),s[n].remove()}}const y={TWO_UP:"TWO_UP",SWIPE:"SWIPE",ONION_SKIN:"ONION_SKIN"};class I extends C{init(e=y.TWO_UP){this.imageFrameEls={[y.TWO_UP]:this.el.querySelector(".two-up .js-image-frame"),[y.SWIPE]:this.el.querySelector(".swipe .js-image-frame"),[y.ONION_SKIN]:this.el.querySelector(".onion-skin .js-image-frame")};const t=this.el.querySelector(".view-modes-menu");this.viewModesEls={[y.TWO_UP]:t.querySelector(".two-up"),[y.SWIPE]:t.querySelector(".swipe"),[y.ONION_SKIN]:t.querySelector(".onion-skin")},this.currentView=e,this.generateImageEls(),this.bindEvents()}generateImageEls(){var e=this;this.imageEls={},Object.getOwnPropertyNames(y).forEach((function(t){e.imageEls[t]=e.imageFrameEls[t].querySelector("img")}))}bindEvents(){super.bindEvents(),this.changeToViewTwoUp=this.changeView.bind(this,y.TWO_UP),this.changeToViewSwipe=this.changeView.bind(this,y.SWIPE),this.changeToViewOnionSkin=this.changeView.bind(this,y.ONION_SKIN),this.viewModesEls[y.TWO_UP].addEventListener("click",this.changeToViewTwoUp),this.viewModesEls[y.SWIPE].addEventListener("click",this.changeToViewSwipe),this.viewModesEls[y.ONION_SKIN].addEventListener("click",this.changeToViewOnionSkin)}get imageEl(){return this.imageEls[this.currentView]}get imageFrameEl(){return this.imageFrameEls[this.currentView]}changeView(e){if(t=e,!Boolean(Object.getOwnPropertyNames(y).find((function(e){return e===t}))))return;var t;const i=b.removeCommentIndicator(this.imageFrameEl);this.currentView=e,[...this.imageFrameEl.querySelectorAll(".badge")].map((function(e){return e.remove()})),this.imageBadges=[],setTimeout(this.renderNewView.bind(this,i),250)}renderNewView(e){if(this.renderBadges(),e.removed){const t=b.resizeCoordinatesToImageElement(this.imageEl,{x:e.x,y:e.y,width:e.image.width,height:e.image.height});b.showCommentIndicator(this.imageFrameEl,t)}}}var E={initImageDiff:function(e,t,i){const n={canCreateNote:t,renderCommentBadge:i};let s;return new u(e),e.querySelector(".diff-file .js-single-image")?(s=new C(e,n)).init():e.querySelector(".diff-file .js-replaced-image")&&(s=new I(e,n)).init(),s}},S=i("3twG"),B=i("FYnm");const N='<div class="diff-content"></div>',O='<span class="spinner"></span>',x=`<div class="nothing-here-block">${Object(f.N)("warning-solid","s16")} Could not load diff</div>`,k='<div class="nothing-here-block diff-collapsed">This diff is collapsed. <button class="click-to-expand btn btn-link">Click to expand it.</button></div>';class D{constructor(e){var t=this;this.file=e,this.toggleDiff=this.toggleDiff.bind(this),this.content=s()(".diff-content",this.file),this.$chevronRightIcon=s()(".diff-toggle-caret .chevron-right",this.file),this.$chevronDownIcon=s()(".diff-toggle-caret .chevron-down",this.file),this.diffForPath=this.content.find("[data-diff-for-path]").data("diffForPath"),this.isOpen=!this.diffForPath,this.diffForPath?(this.collapsedContent=this.content,this.loadingContent=s()(N).addClass("loading").html(O).hide(),this.content=null,this.collapsedContent.after(this.loadingContent),this.$chevronRightIcon.removeClass("gl-display-none")):(this.collapsedContent=s()(N).html(k).hide(),this.content.after(this.collapsedContent),this.$chevronDownIcon.removeClass("gl-display-none")),s()(".js-file-title, .click-to-expand",this.file).on("click",(function(e){t.toggleDiff(s()(e.target))}))}toggleDiff(e,t){if(e.hasClass("js-file-title")||e.hasClass("click-to-expand")||!(!e.closest(".diff-toggle-caret").length>0))if(this.isOpen=!this.isOpen,this.isOpen||this.hasError){if(!this.content)return this.$chevronDownIcon.removeClass("gl-display-none"),this.$chevronRightIcon.addClass("gl-display-none"),this.getContentHTML(t);this.collapsedContent.hide(),this.content.show(),this.$chevronDownIcon.removeClass("gl-display-none"),this.$chevronRightIcon.addClass("gl-display-none")}else this.content.hide(),this.$chevronRightIcon.removeClass("gl-display-none"),this.$chevronDownIcon.addClass("gl-display-none"),this.collapsedContent.show()}getContentHTML(e){var t=this;return this.collapsedContent.hide(),this.loadingContent.show(),o.a.get(this.diffForPath).then((function({data:i}){t.loadingContent.hide(),i.html?(t.content=s()(i.html),Object(B.a)(t.content)):(t.hasError=!0,t.content=s()(x)),t.collapsedContent.after(t.content);const n=s()(t.file);d.init(n);const a=n.closest(".files").is("[data-can-create-note]");E.initImageDiff(n[0],a),e&&e()})).catch((function(){Object(a.c)({message:Object(r.a)("An error occurred while retrieving diff")})}))}}const T=20;let L=!1;class P{constructor(){const e=s()(".files .diff-file");e.each((function(e,t){s.a.data(t,"singleFileDiff")||s.a.data(t,"singleFileDiff",new D(t))}));const t=document.getElementById("diffs");(!t||t&&t.dataset&&""!==t.dataset.isLocked)&&d.init(e);const i=s()(".files").first().get(0),n=i&&i.hasAttribute("data-can-create-note");e.each((function(e,t){return E.initImageDiff(t,n)})),L||(s()(document).on("click",".js-unfold",this.handleClickUnfold.bind(this)).on("click",".diff-line-num a",this.handleClickLineNum.bind(this)).on("mousedown","td.line_content.parallel",this.handleParallelLineDown.bind(this)),L=!0),Object(S.i)()&&this.highlightSelectedLine(),this.openAnchoredDiff()}handleClickUnfold(e){const t=s()(e.target),[i,n]=this.lineNumbers(t.parent()),l=n-i,c=t.hasClass("js-unfold-bottom");let d,h,g=!0;if(c){const e=n+1;d=e,h=e+T}else{const e=n-1;d=e-T,h=e;const i=this.lineNumbers(t.parent().prev())[1];d<=i+1&&(d=i+1,g=!1)}const u=t.parents(".diff-file"),f=u.data("blobDiffPath"),m={since:d,to:h,bottom:c,offset:l,unfold:g,view:u.data("view")};o.a.get(f,{params:m}).then((function({data:e}){return t.parent().replaceWith(e)})).catch((function(){return Object(a.c)({message:Object(r.a)("An error occurred while loading diff")})}))}openAnchoredDiff(e){var t=this;const i=Object(S.i)(),n=i&&i.split("_")[0];if(!n)return;const a=s()(`#${n}`).closest(".diff-file");if(s()(".nothing-here-block:visible",a).length){const i=s()(".js-file-title, .click-to-expand",a);a.data("singleFileDiff").toggleDiff(i,(function(){t.highlightSelectedLine(),e&&e()}))}else e&&e()}handleClickLineNum(e){const t=s()(e.currentTarget).attr("href");e.preventDefault(),window.history.pushState?window.history.pushState(null,null,t):window.location.hash=t,this.highlightSelectedLine()}handleParallelLineDown(e){const t=s()(e.currentTarget),i=t.closest("table");i.removeClass("left-side-selected right-side-selected");const n=["left-side","right-side"].filter((function(e){return t.hasClass(e)}))[0];n&&i.addClass(`${n}-selected`)}diffViewType(){return s()(".inline-parallel-buttons a.active").data("viewType")}lineNumbers(e){const t=e.find(".diff-line-num").toArray();return 2!==t.length?[0,0]:t.map((function(e){return parseInt(s()(e).data("linenumber"),10)||0}))}highlightSelectedLine(){const e=Object(S.i)(),t=s()(".diff-file");t.find(".hll").removeClass("hll"),e&&t.find(`tr#${e}:not(.match) td, td#${e}, td[data-line-code="${e}"]`).addClass("hll")}}}}]);
//# sourceMappingURL=commons-pages.projects.commit.show-pages.projects.compare.show-pages.projects.merge_requests.creatio-797be524.2ef66aab.chunk.js.map